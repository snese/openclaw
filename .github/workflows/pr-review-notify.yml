name: PR Review Notifier

on:
  pull_request_review_comment:
    types: [created]

jobs:
  notify:
    if: >
      github.event.comment.user.login != 'snese' &&
      github.event.pull_request.number == 28601
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          AUTHOR="${{ github.event.comment.user.login }}"
          URL="${{ github.event.comment.html_url }}"
          # Truncate body to 500 chars for Telegram
          BODY=$(echo '${{ toJSON(github.event.comment.body) }}' | python3 -c "
          import sys,json
          s=json.loads(sys.stdin.read())
          # strip markdown badges
          import re; s=re.sub(r'\*\*<sub>.*?</sub>\s*', '', s)
          print(s[:500]+'...' if len(s)>500 else s)
          ")
          MSG="ðŸ”” <b>PR #28601 review comment</b>
          From: <code>${AUTHOR}</code>
          ${BODY}

          <a href=\"${URL}\">View comment</a>"

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode=HTML \
            -d disable_web_page_preview=true \
            --data-urlencode "text=${MSG}"
