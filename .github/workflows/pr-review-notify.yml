name: PR Review Notifier

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest
    steps:
      - name: Check for new review comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Poll upstream PR for comments in the last 6 minutes (overlap for safety)
          SINCE=$(date -u -d '6 minutes ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-6M +%Y-%m-%dT%H:%M:%SZ)

          COMMENTS=$(curl -s \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/openclaw/openclaw/pulls/28601/comments?since=${SINCE}&sort=created&direction=desc&per_page=30")

          # Filter: not by snese, created after SINCE
          echo "$COMMENTS" | python3 -c "
          import json, sys, urllib.request, urllib.parse, os, re
          comments = json.loads(sys.stdin.read())
          if not isinstance(comments, list):
              sys.exit(0)
          bot_token = os.environ['BOT_TOKEN']
          chat_id = os.environ['CHAT_ID']
          since = '${SINCE}'
          for c in comments:
              if c['user']['login'] == 'snese':
                  continue
              if c['created_at'] < since:
                  continue
              author = c['user']['login']
              url = c['html_url']
              body = re.sub(r'\*\*<sub>.*?</sub>\s*', '', c['body'])
              body = body[:400] + '...' if len(body) > 400 else body
              # Escape HTML
              body = body.replace('&','&amp;').replace('<','&lt;').replace('>','&gt;')
              msg = f'ðŸ”” <b>PR #28601 review</b>\nFrom: <code>{author}</code>\n{body}\n\n<a href=\"{url}\">View</a>'
              data = urllib.parse.urlencode({
                  'chat_id': chat_id,
                  'parse_mode': 'HTML',
                  'disable_web_page_preview': 'true',
                  'text': msg
              }).encode()
              try:
                  urllib.request.urlopen(f'https://api.telegram.org/bot{bot_token}/sendMessage', data)
                  print(f'Notified: {author} @ {c[\"created_at\"]}')
              except Exception as e:
                  print(f'Failed: {e}')
          "
